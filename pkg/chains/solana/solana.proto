syntax = "proto3";
option go_package = "github.com/smartcontractkit/chainlink-common/pkg/chains/solana";

import "loop/chain-common/query.proto";
import "values/v1/values.proto";

package loop.solana;

service Solana {
  rpc GetAccountInfoWithOpts(GetAccountInfoWithOptsRequest) returns (GetAccountInfoWithOptsReply);
  rpc GetBalance(GetBalanceRequest) returns (GetBalanceReply);
  rpc GetBlock(GetBlockRequest) returns (GetBlockReply);
  rpc GetFeeForMessage(GetFeeForMessageRequest) returns (GetFeeForMessageReply);
  rpc GetMultipleAccountsWithOpts(GetMultipleAccountsWithOptsRequest) returns (GetMultipleAccountsWithOptsReply);
  rpc GetSignatureStatuses(GetSignatureStatusesRequest) returns (GetSignatureStatusesReply);
  rpc GetSlotHeight(GetSlotHeightRequest) returns (GetSlotHeightReply);
  rpc GetTransaction(GetTransactionRequest) returns (GetTransactionReply);
  rpc QueryTrackedLogsSol(QueryTrackedLogsRequest) returns (QueryTrackedLogsReply);
  rpc RegisterLogTrackingSol(RegisterLogTrackingRequest) returns (RegisterLogTrackingReply);
  rpc SimulateTX(SimulateTXRequest) returns (SimulateTXReply);
  rpc SubmitTransactionSol(SubmitTransactionRequest) returns (SubmitTransactionReply);
  rpc UnregisterLogTrackingSol(UnregisterLogTrackingRequest) returns (UnregisterLogTrackingReply);
}

enum TransactionStatus {
	TX_FATAL = 0;
	TX_ABORTED = 1;
	TX_SUCCESS = 2;
}

enum TransactionDetailsType {
	TRANSACTION_DETAILS_FULL = 0;
	TRANSCTION_DETAILS_SIGNATURES = 1;
	TRANSACTION_DETAILS_NONE = 2;
	TRANSACTION_DETAILS_ACCOUNTS = 3;
}

enum EncodingType {
	ENCODING_NONE = 0;
	ENCODING_BASE58  = 1;   // limited to Account data of less than 129 bytes
	ENCODING_BASE64 = 2;     // will return base64 encoded data for Account data of any size
	ENCODING_BASE64_ZST = 3; // compresses the Account data using Zstandard and base64-encodes the result
	// attempts to use program-specific state parsers to
	// return more human-readable and explicit account state data.
	// If "jsonParsed" is requested but a parser cannot be found,
	// the field falls back to "base64" encoding, detectable when the data field is type <string>.
	// Cannot be used if specifying dataSlice parameters (offset, length).
	ENCODING_JSON_PARSED = 4;

	ENCODING_JSON = 5; // NOTE: you're probably looking for EncodingJSONParsed
}

enum CommitmentType {
	COMMITMENT_NONE = 0;
	COMMITMENT_FINALIZED = 1;
	COMMITMENT_CONFIRMED = 2;
	COMMITMENT_PROCESSED = 3;
}

enum ConfirmationStatusType {
	CONFIRMATION_NONE = 0;
	CONFIRMATION_PROCESSED = 1;
	CONFIRMATION_CONFIRMED = 2;
	CONFIRMATION_FINALIZED = 3;
}

message Account {
  uint64 lamports = 1;
  bytes owner = 2;
  DataBytesOrJSON data = 3;
  bool executable = 4;
  values.v1.BigInt  rent_epoch = 5;
  uint64 space = 6;
}

message Address {
  bytes address = 1;
}

message ComputeConfig {
  uint32 compute_limit = 1;
  uint64 compute_max_price = 2;
}

message Context {
  uint64 slot = 1;
}

message DataBytesOrJSON {
  EncodingType raw_data_encoding = 1;
  bytes as_decoded_binary = 2;
  bytes as_json = 3;
}

message DataSlice {
  uint64 offset = 1;
  uint64 length = 2;
}

message EventSig {
  uint64 topic = 1;
  repeated HashedValueComparator hashed_value_comparers = 2;
}

message IndexedValueComparator {
	bytes value = 1;
  	loop.chain.common.ComparisonOperator operator = 2;
}

message EventBySubkey {
	uint64 subkey_index = 1;
	repeated IndexedValueComparator value_comparers = 2;
}

message Expression {
 oneof evaluator {
    Primitive primitive = 1;
    BooleanExpression boolean_expression = 2;
  }
}

message BooleanExpression {
  loop.chain.common.BooleanOperator boolean_operator = 1;
  repeated Expression expression = 2;
}

message GetAccountInfoOpts {
  EncodingType encoding = 1;
  CommitmentType commitment = 2;
  DataSlice data_slice = 3;
  uint64 min_context_slot = 4;
}

message GetAccountInfoWithOptsReply {
  RPCContext rpc_context = 1;
  Account value = 2;
}

message GetAccountInfoWithOptsRequest {
  bytes account = 1;
  GetAccountInfoOpts opts = 2;
}

message GetBalanceReply {
  uint64 value = 1;
}

message GetBalanceRequest {
  bytes addr = 1;
  CommitmentType commitment = 2;
}

message GetBlockOpts {
  EncodingType encoding = 1;
  TransactionDetailsType transaction_details = 2;
  bool rewards = 3;
  CommitmentType commitment = 4;
  uint64 max_supported_transaction_version = 5;
}

message GetBlockReply {
  bytes blockhash = 1;
  bytes previous_blockhash = 2;
  uint64 parent_slot = 3;
  repeated TransactionWithMeta transactions = 4;
  repeated bytes signatures = 5;
  int64 block_time = 6;
  uint64 block_height = 7;
}

message GetBlockRequest {
  uint64 slot = 1;
  GetBlockOpts opts = 2;
}

message GetFeeForMessageReply {
  uint64 fee = 1;
}

message GetFeeForMessageRequest {
  string message = 1;
  CommitmentType commitment = 2;
}

message GetMultipleAccountsOpts {
  EncodingType encoding = 1;
  CommitmentType commitment = 2;
  DataSlice data_slice = 3;
  uint64 min_context_slot = 4;
}

message GetMultipleAccountsWithOptsReply {
  RPCContext r_p_c_context = 1;
  repeated Account value = 2;
}

message GetMultipleAccountsWithOptsRequest {
  repeated bytes accounts = 1;
  GetMultipleAccountsOpts opts = 2;
}

message GetSignatureStatusesReply {
  repeated GetSignatureStatusesResult results = 1;
}

message GetSignatureStatusesRequest {
  repeated bytes sigs = 1;
}

message GetSignatureStatusesResult {
  uint64 slot = 1;
  uint64 confirmations = 2;
  string err = 3;
  ConfirmationStatusType confirmation_status = 4;
}

message GetSlotHeightReply {
  uint64 height = 1;
}

message GetSlotHeightRequest {
  CommitmentType commitment = 1;
}

message MessageHeader {
	uint32 num_required_signatures = 1;
	uint32 num_readonly_signed_accounts = 2;
	uint32 num_readonly_unsigned_accounts = 3;
}

message ParsedMessage {
  bytes recent_blockhash = 1;  // 32 bytes solana Hash
  repeated bytes account_keys = 2; // list of 32 bytes account keys
  MessageHeader header = 3;
  repeated CompiledInstruction instructions = 4;
}

message ParsedTransaction {
  repeated bytes signatures = 1; // 64 bytes solana Signature each
  ParsedMessage message = 2;
}

message UiTokenAmount {
  string amount = 1;                 // raw integer as string
  uint32 decimals = 2;
  string ui_amount_string = 4;
}

message TokenBalance {
  uint32 account_index = 1;
  bytes  owner = 2;      // 32 bytes solana PublicKey
  bytes  program_id = 3; // 32 bytes solana PublicKey
  bytes  mint = 4;       // 32 bytes solana PublicKey
  UiTokenAmount ui = 5;
}

message InnerInstruction {
  uint32 index = 1;
  repeated CompiledInstruction instructions = 2;
}

message LoadedAddresses {
  repeated bytes readonly = 1; // 32 bytes solana PublicKey
  repeated bytes writable = 2; // 32 bytes solana PublicKey
}

message CompiledInstruction {
  uint32 program_id_index = 1;
  repeated uint32 accounts = 2;
  bytes  data = 3;
  uint32 stack_height = 4;
}

message Data {
	bytes content = 1;
	EncodingType encoding = 2;
}

message ReturnData {
  bytes program_id = 1; // 32 bytes solana publicKey
  Data data = 2;       // raw program return bytes
}

message TransactionMeta {
  string err_json = 1;

  uint64 fee = 2;
  repeated uint64 pre_balances  = 3;
  repeated uint64 post_balances = 4;

  repeated string log_messages = 5;

  repeated TokenBalance pre_token_balances  = 6;
  repeated TokenBalance post_token_balances = 7;

  repeated InnerInstruction inner_instructions = 8;

  LoadedAddresses loaded_addresses = 9;

  ReturnData return_data = 10;

  uint64 compute_units_consumed = 11;
}

message TransactionEnvelope {
// - For RAW encoding, "transaction" contains tx bytes; for PARSED, structured fields.
	oneof  transaction{
		bytes raw = 1;
		ParsedTransaction parsed = 2;
	}
}

message GetTransactionReply {
  uint64 slot = 1;
  int64 block_time = 2;
 	
  TransactionEnvelope transaction = 3;    
  TransactionMeta meta = 12;    // - "meta" may be omitted by the node/config.
}

message GetTransactionRequest {
  bytes signature = 1; // 64 bytes signature
}

message HashedValueComparator {
  repeated bytes values = 1;
  int64 operator = 2;
}

message Subkeys {
	repeated string subkeys = 1;
}

message LPFilterQuery {
  string name = 1;
  bytes address = 2;
  string event_name = 3;
  bytes event_sig = 4;
  int64 starting_block = 5;
  bytes event_idl_json = 6;
  repeated Subkeys subkey_paths = 7;
  int64 retention = 8;
  int64 max_logs_kept = 9;
  bool include_reverted = 10;
}

message Limit {
  string cursor = 1;
  int32 cursor_direction = 2;
  uint64 count = 3;
}

message LimitAndSort {
  Limit limit = 1;
}

message Log {
  string chain_id = 1;
  int64 log_index = 2;
  bytes block_hash = 3;
  int64 block_number = 4;
  uint64 block_timestamp = 5;
  bytes address = 6;
  bytes event_sig = 7;
  bytes tx_hash = 8;
  bytes data = 9;
  int64 sequence_num = 10;
  string error = 11;
}

message RPCContext {
  Context context = 1;
}

message SimulateTXOpts {
  bool sig_verify = 1;
  CommitmentType commitment = 2;
  bool replace_recent_blockhash = 3;
  SimulateTransactionAccountsOpts accounts = 4;
}

message SimulateTXReply {
  string err = 1;
  repeated string logs = 2;
  repeated Account accounts = 3;
  uint64 units_consumed = 4;
}

message SimulateTXRequest {
  bytes receiver = 1;
  string encoded_transaction = 2;
  SimulateTXOpts opts = 3;
}

message SimulateTransactionAccountsOpts {
  EncodingType encoding = 1;
  repeated bytes addresses = 2;
}

message SubmitTransactionReply {
  bytes signature = 1;
  string idempotency_key = 2;
  TransactionStatus status = 3;
}

message SubmitTransactionRequest {
  ComputeConfig cfg = 1;
  bytes receiver = 2;
  string encoded_transaction = 3;
}

message TransactionWithMeta {
  uint64 slot = 1;
  int64 block_time = 2;
  DataBytesOrJSON transaction = 3;
  TransactionMeta  meta = 4;
  int64 version = 5;
}

message Primitive {
  oneof primitive {
    loop.chain.common.Primitive general_primitive = 1;
    bytes address = 2; // filter event by program public key 32 bytes 
    bytes event_sig = 3; //  filter event by event signature  8 bytes length
    EventBySubkey event_by_subkey = 4; // filter event by subkey
  }
}

message QueryTrackedLogsRequest {
  repeated Expression filterQuery = 1;
  loop.chain.common.LimitAndSort limit_and_sort = 2;
}

message QueryTrackedLogsReply {
  repeated Log logs = 1;
}

message RegisterLogTrackingRequest {
  LPFilterQuery filter = 1;
}

message RegisterLogTrackingReply {
}

message UnregisterLogTrackingRequest {
  string filterName = 1;
}

message UnregisterLogTrackingReply {
}
