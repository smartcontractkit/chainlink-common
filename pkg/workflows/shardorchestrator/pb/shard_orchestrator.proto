syntax = "proto3";

package shardorchestrator;

option go_package = "github.com/smartcontractkit/chainlink-common/pkg/workflows/shardorchestrator/pb";

message GetWorkflowShardMappingRequest {
  repeated string workflow_ids = 1;
}

message WorkflowMappingState {
  uint32 old_shard_id = 1;
  uint32 new_shard_id = 2;
  bool in_transition = 3;
}

message GetWorkflowShardMappingResponse {
  map<string, uint32> mappings = 1;
  map<string, WorkflowMappingState> mapping_states = 2;
  uint64 mapping_version = 3;
}

message ReportWorkflowTriggerRegistrationRequest {
  uint32 source_shard_id = 1;
  map<string, uint32> registered_workflows = 2;
  uint32 total_active_workflows = 3;
}

message ReportWorkflowTriggerRegistrationResponse {
  bool success = 1;
}

message ReportWorkflowsRequest {
  repeated string workflow_ids = 1;
}

message ReportWorkflowsResponse {
  bool success = 1;
}

message GetWorkflowsForShardRequest {
  uint32 shard_id = 1;
}

message GetWorkflowsForShardResponse {
  repeated string workflow_ids = 1;
}

service ShardOrchestratorService {
  rpc GetWorkflowShardMapping(GetWorkflowShardMappingRequest) returns (GetWorkflowShardMappingResponse); // returns shard assignments for the specified workflows
  rpc ReportWorkflowTriggerRegistration(ReportWorkflowTriggerRegistrationRequest) returns (ReportWorkflowTriggerRegistrationResponse); // called by shards to report their workflow trigger registrations

  rpc ReportWorkflows(ReportWorkflowsRequest) returns (ReportWorkflowsResponse); // called by shard 0 to inform the workflows seen on-chain
  rpc GetWorkflowsForShard(GetWorkflowsForShardRequest) returns (GetWorkflowsForShardResponse); // called by all shards to fetch the workflows it has assigned
}
