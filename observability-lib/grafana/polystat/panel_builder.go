package polystat

import (
	"errors"

	"github.com/grafana/grafana-foundation-sdk/go/cog"
	"github.com/grafana/grafana-foundation-sdk/go/cog/variants"
	"github.com/grafana/grafana-foundation-sdk/go/dashboard"
)

var _ cog.Builder[dashboard.Panel] = (*PanelBuilder)(nil)

type PanelBuilder struct {
	internal *dashboard.Panel
	errors   map[string]cog.BuildErrors
}

func NewPanelBuilder() *PanelBuilder {
	resource := &dashboard.Panel{}
	builder := &PanelBuilder{
		internal: resource,
		errors:   make(map[string]cog.BuildErrors),
	}

	builder.applyDefaults()
	builder.internal.Type = "grafana-polystat-panel"

	return builder
}

func (builder *PanelBuilder) Build() (dashboard.Panel, error) {
	var errs cog.BuildErrors

	for _, err := range builder.errors {
		errs = append(errs, cog.MakeBuildErrors("Panel", err)...)
	}

	if len(errs) != 0 {
		return dashboard.Panel{}, errs
	}

	return *builder.internal, nil
}

// The version of the plugin that is used for this panel. This is used to find the plugin to display the panel and to migrate old panel configs.
func (builder *PanelBuilder) PluginVersion(pluginVersion string) *PanelBuilder {
	builder.internal.PluginVersion = &pluginVersion

	return builder
}

// Unique identifier of the panel. Generated by Grafana when creating a new panel. It must be unique within a dashboard, but not globally.
func (builder *PanelBuilder) Id(id uint32) *PanelBuilder {
	builder.internal.Id = &id

	return builder
}

// Panel title.
func (builder *PanelBuilder) Title(title string) *PanelBuilder {
	builder.internal.Title = &title

	return builder
}

// Panel description.
func (builder *PanelBuilder) Description(description string) *PanelBuilder {
	builder.internal.Description = &description

	return builder
}

// Whether to display the panel without a background.
func (builder *PanelBuilder) Transparent(transparent bool) *PanelBuilder {
	builder.internal.Transparent = &transparent

	return builder
}

// The datasource used in all targets.
func (builder *PanelBuilder) Datasource(datasource dashboard.DataSourceRef) *PanelBuilder {
	builder.internal.Datasource = &datasource

	return builder
}

// Grid position.
func (builder *PanelBuilder) GridPos(gridPos dashboard.GridPos) *PanelBuilder {
	builder.internal.GridPos = &gridPos

	return builder
}

// Panel height. The height is the number of rows from the top edge of the panel.
func (builder *PanelBuilder) Height(h uint32) *PanelBuilder {
	if !(h > 0) {
		builder.errors["h"] = cog.MakeBuildErrors("h", errors.New("h must be > 0"))
		return builder
	}
	if builder.internal.GridPos == nil {
		builder.internal.GridPos = &dashboard.GridPos{}
	}
	builder.internal.GridPos.H = h

	return builder
}

// Panel width. The width is the number of columns from the left edge of the panel.
func (builder *PanelBuilder) Span(w uint32) *PanelBuilder {
	if !(w > 0) {
		builder.errors["w"] = cog.MakeBuildErrors("w", errors.New("w must be > 0"))
		return builder
	}
	if !(w <= 24) {
		builder.errors["w"] = cog.MakeBuildErrors("w", errors.New("w must be <= 24"))
		return builder
	}
	if builder.internal.GridPos == nil {
		builder.internal.GridPos = &dashboard.GridPos{}
	}
	builder.internal.GridPos.W = w

	return builder
}

// Panel links.
func (builder *PanelBuilder) Links(links []cog.Builder[dashboard.DashboardLink]) *PanelBuilder {
	linksResources := make([]dashboard.DashboardLink, 0, len(links))
	for _, r1 := range links {
		linksDepth1, err := r1.Build()
		if err != nil {
			builder.errors["links"] = err.(cog.BuildErrors)
			return builder
		}
		linksResources = append(linksResources, linksDepth1)
	}
	builder.internal.Links = linksResources

	return builder
}

// Name of template variable to repeat for.
func (builder *PanelBuilder) Repeat(repeat string) *PanelBuilder {
	builder.internal.Repeat = &repeat

	return builder
}

// Direction to repeat in if 'repeat' is set.
// `h` for horizontal, `v` for vertical.
func (builder *PanelBuilder) RepeatDirection(repeatDirection dashboard.PanelRepeatDirection) *PanelBuilder {
	builder.internal.RepeatDirection = &repeatDirection

	return builder
}

// Option for repeated panels that controls max items per row
// Only relevant for horizontally repeated panels
func (builder *PanelBuilder) MaxPerRow(maxPerRow float64) *PanelBuilder {
	builder.internal.MaxPerRow = &maxPerRow

	return builder
}

// WithTarget adds a target to the panel.
func (builder *PanelBuilder) WithTarget(target cog.Builder[variants.Dataquery]) *PanelBuilder {
	resource, err := target.Build()
	if err != nil {
		builder.errors["Targets"] = err.(cog.BuildErrors)
		return builder
	}

	builder.internal.Targets = append(builder.internal.Targets, resource)

	return builder
}

// Operator name for aggregation
func (builder *PanelBuilder) OperatorName(operatorName OperatorName) *PanelBuilder {
	if builder.internal.Options == nil {
		builder.internal.Options = &Options{}
	}
	builder.internal.Options.(*Options).OperatorName = operatorName

	return builder
}

// Global fill color for polygons
func (builder *PanelBuilder) PolygonGlobalFillColor(color string) *PanelBuilder {
	if builder.internal.Options == nil {
		builder.internal.Options = &Options{}
	}
	builder.internal.Options.(*Options).PolygonGlobalFillColor = color

	return builder
}

// Size of polygons
func (builder *PanelBuilder) PolygonSize(size PolygonSize) *PanelBuilder {
	if builder.internal.Options == nil {
		builder.internal.Options = &Options{}
	}
	builder.internal.Options.(*Options).PolygonSize = size

	return builder
}

// Number of columns for layout
func (builder *PanelBuilder) Columns(columns int) *PanelBuilder {
	if builder.internal.Options == nil {
		builder.internal.Options = &Options{}
	}
	builder.internal.Options.(*Options).Columns = columns

	return builder
}

// Number of rows for layout
func (builder *PanelBuilder) Rows(rows int) *PanelBuilder {
	if builder.internal.Options == nil {
		builder.internal.Options = &Options{}
	}
	builder.internal.Options.(*Options).Rows = rows

	return builder
}

// Maximum number of items to display
func (builder *PanelBuilder) DisplayLimit(limit int) *PanelBuilder {
	if builder.internal.Options == nil {
		builder.internal.Options = &Options{}
	}
	builder.internal.Options.(*Options).DisplayLimit = limit

	return builder
}

// Default click through URL
func (builder *PanelBuilder) DefaultClickThrough(url string) *PanelBuilder {
	if builder.internal.Options == nil {
		builder.internal.Options = &Options{}
	}
	builder.internal.Options.(*Options).DefaultClickThrough = url

	return builder
}

// Open click through in new tab
func (builder *PanelBuilder) DefaultClickThroughNewTab(newTab bool) *PanelBuilder {
	if builder.internal.Options == nil {
		builder.internal.Options = &Options{}
	}
	builder.internal.Options.(*Options).DefaultClickThroughNewTab = newTab

	return builder
}

// Sanitize click through URL
func (builder *PanelBuilder) DefaultClickThroughSanitize(sanitize bool) *PanelBuilder {
	if builder.internal.Options == nil {
		builder.internal.Options = &Options{}
	}
	builder.internal.Options.(*Options).DefaultClickThroughSanitize = sanitize

	return builder
}

// Animation speed in milliseconds
func (builder *PanelBuilder) AnimationSpeed(speed int) *PanelBuilder {
	if builder.internal.Options == nil {
		builder.internal.Options = &Options{}
	}
	builder.internal.Options.(*Options).AnimationSpeed = speed

	return builder
}

// Border radius for polygons
func (builder *PanelBuilder) Radius(radius string) *PanelBuilder {
	if builder.internal.Options == nil {
		builder.internal.Options = &Options{}
	}
	builder.internal.Options.(*Options).Radius = radius

	return builder
}

// Tooltip display mode
func (builder *PanelBuilder) TooltipDisplayMode(mode string) *PanelBuilder {
	if builder.internal.Options == nil {
		builder.internal.Options = &Options{}
	}
	builder.internal.Options.(*Options).TooltipDisplayMode = mode

	return builder
}

// Primary sort field for tooltip
func (builder *PanelBuilder) TooltipPrimarySortBy(field SortByField) *PanelBuilder {
	if builder.internal.Options == nil {
		builder.internal.Options = &Options{}
	}
	builder.internal.Options.(*Options).TooltipPrimarySortBy = field

	return builder
}

// Primary sort direction for tooltip
func (builder *PanelBuilder) TooltipPrimarySortDirection(direction SortByDirection) *PanelBuilder {
	if builder.internal.Options == nil {
		builder.internal.Options = &Options{}
	}
	builder.internal.Options.(*Options).TooltipPrimarySortDir = direction

	return builder
}

// Secondary sort field for tooltip
func (builder *PanelBuilder) TooltipSecondarySortBy(field SortByField) *PanelBuilder {
	if builder.internal.Options == nil {
		builder.internal.Options = &Options{}
	}
	builder.internal.Options.(*Options).TooltipSecondarySortBy = field

	return builder
}

// Secondary sort direction for tooltip
func (builder *PanelBuilder) TooltipSecondarySortDirection(direction SortByDirection) *PanelBuilder {
	if builder.internal.Options == nil {
		builder.internal.Options = &Options{}
	}
	builder.internal.Options.(*Options).TooltipSecondarySortDir = direction

	return builder
}

// Global unit format
func (builder *PanelBuilder) GlobalUnitFormat(format string) *PanelBuilder {
	if builder.internal.Options == nil {
		builder.internal.Options = &Options{}
	}
	builder.internal.Options.(*Options).GlobalUnitFormat = format

	return builder
}

// Global decimals
func (builder *PanelBuilder) GlobalDecimals(decimals int) *PanelBuilder {
	if builder.internal.Options == nil {
		builder.internal.Options = &Options{}
	}
	builder.internal.Options.(*Options).GlobalDecimals = decimals

	return builder
}

// Global display mode
func (builder *PanelBuilder) GlobalDisplayMode(mode string) *PanelBuilder {
	if builder.internal.Options == nil {
		builder.internal.Options = &Options{}
	}
	builder.internal.Options.(*Options).GlobalDisplayMode = mode

	return builder
}

// Global display text when triggered empty
func (builder *PanelBuilder) GlobalDisplayTextTriggeredEmpty(text string) *PanelBuilder {
	if builder.internal.Options == nil {
		builder.internal.Options = &Options{}
	}
	builder.internal.Options.(*Options).GlobalDisplayTextTriggeredEmpty = text

	return builder
}

// Global thresholds configuration
func (builder *PanelBuilder) GlobalThresholds(thresholds []Threshold) *PanelBuilder {
	if builder.internal.Options == nil {
		builder.internal.Options = &Options{}
	}
	builder.internal.Options.(*Options).GlobalThresholdsConfig = thresholds

	return builder
}

func (builder *PanelBuilder) applyDefaults() {
	builder.PluginVersion("2.1.11")
	builder.Height(8)
	builder.Span(12)
	builder.OperatorName(OperatorNameCurrent)
	builder.PolygonSize(PolygonSizeMedium)
	builder.AnimationSpeed(2500)
	builder.Radius("5px")
}
