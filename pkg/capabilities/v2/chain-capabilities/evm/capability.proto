syntax = "proto3";

option go_package = "github.com/smartcontractkit/chainlink-common/pkg/capabilities/v2/chain-capabilities/evm;evm";

package cre.sdk.v2.evm;

import "google/protobuf/empty.proto";
import "tools/generator/v1alpha/cre_metadata.proto";
import "chains/evm/evm.proto";
import "values/pb/values.proto";

enum ConfidenceLevel {
  SAFE = 0;
  LATEST = 1;
  FINALIZED = 2;
}

message FilterLogTriggerRequest {
  repeated bytes addresses = 1; // list of addresses to include in evm address [20]byte fix-sized array format, at least one address is required
  repeated bytes event_sigs = 2; // list of possible signatures (aka topic1), in [32]byte fix-sized array format, at least one topic is required
  repeated bytes topic2 = 3; // list of possible values for topic2, in [32]byte fix-sized array format, can be empty
  repeated bytes topic3 = 4; // list of possible values for topic3, in [32]byte fix-sized array format, can be empty
  repeated bytes topic4 = 5; // list of possible values for topic4, in [32]byte fix-sized array format, can be empty
  ConfidenceLevel Confidence = 6; // optional, defaults to "SAFE"
}

service Client {
  option (tools.generator.v1alpha.capability) = {
    mode: MODE_DON
    capability_id: "evm@1.0.0"
  };
  rpc CallContract(loop.evm.CallContractRequest) returns (loop.evm.CallContractReply);
  rpc FilterLogs(loop.evm.FilterLogsRequest) returns (loop.evm.FilterLogsReply);
  rpc BalanceAt(loop.evm.BalanceAtRequest) returns (loop.evm.BalanceAtReply);
  rpc EstimateGas(loop.evm.EstimateGasRequest) returns (loop.evm.EstimateGasReply);
  rpc GetTransactionByHash(loop.evm.GetTransactionByHashRequest) returns (loop.evm.GetTransactionByHashReply);
  rpc GetTransactionReceipt(loop.evm.GetTransactionReceiptRequest) returns (loop.evm.GetTransactionReceiptReply);
  rpc LatestAndFinalizedHead(google.protobuf.Empty) returns (loop.evm.LatestAndFinalizedHeadReply);
  rpc QueryTrackedLogs(loop.evm.QueryTrackedLogsRequest) returns (loop.evm.QueryTrackedLogsReply);
  rpc RegisterLogTracking(loop.evm.RegisterLogTrackingRequest) returns (google.protobuf.Empty);
  rpc UnregisterLogTracking(loop.evm.UnregisterLogTrackingRequest) returns (google.protobuf.Empty);
  rpc WriteReport(WriteReportRequest) returns (WriteReportReply);

}

message SignedReport {
  bytes raw_report = 1;
  bytes report_context = 2;
  repeated bytes signatures = 3;
  bytes id = 4;
}

enum ReceiverContractExecutionStatus {
  SUCCESS = 0;
  REVERTED = 1;
}

message WriteReportRequest {
    bytes receiver = 1;
    SignedReport report = 2;
    optional GasConfig gas_config = 3; 
}

message GasConfig {
  uint64 gas_limit = 1;
}

message WriteReportReply {
  loop.evm.TxStatus tx_status = 1;
  optional ReceiverContractExecutionStatus receiver_contract_execution_status = 2;
  optional bytes tx_hash = 3;
  optional values.BigInt transaction_fee = 4;
  optional string error_message = 5;
}